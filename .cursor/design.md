# Дизайн VIN Report Bot

## Высокоуровневая архитектура

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   Пользователь   │    │     Бот      │    │  Менеджер   │
└─────────────┘    └──────────────┘    └─────────────┘
       │                   │                   │
       │ VIN               │                   │
       ├──────────────────►│                   │
       │                   │                   │
       │ "Заявка принята"  │                   │
       │◄──────────────────┤                   │
       │                   │                   │
       │                   │ Карточка заявки   │
       │                   ├──────────────────►│
       │                   │                   │
       │                   │ Take/Done hint    │
       │                   │◄──────────────────┤
       │                   │                   │
       │                   │ PDF (reply)       │
       │                   │◄──────────────────┤
       │                   │                   │
       │ PDF отчет         │                   │
       │◄──────────────────┤                   │
       │                   │                   │
       │                   │ "Заявка закрыта"  │
       │                   ├──────────────────►│
```

## Модель данных

### Таблица tickets
```sql
CREATE TABLE tickets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    vin TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    status TEXT NOT NULL CHECK (status IN ('NEW', 'TAKEN', 'DONE')),
    assignee_id INTEGER NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Индексы
- `idx_tickets_status` на `status`
- `idx_tickets_user_id` на `user_id`
- `idx_tickets_assignee_id` на `assignee_id`

## Последовательность операций

### 1. Создание заявки
1. Пользователь отправляет VIN
2. Валидация VIN
3. Создание записи в БД (status=NEW)
4. Ответ пользователю: "Заявка №{id} принята... Статус: в работе"
5. Отправка карточки в MANAGER_CHAT

### 2. Назначение заявки
1. Менеджер нажимает "Take"
2. Обновление записи (status=TAKEN, assignee_id=manager_id)
3. Редактирование сообщения: добавление "Назначена: @manager"
4. Обновление клавиатуры: только "Done hint"

### 3. Завершение заявки
1. Менеджер отвечает PDF на карточку заявки
2. Извлечение ticket_id из текста сообщения
3. Получение user_id по ticket_id
4. Обновление статуса (status=DONE)
5. Отправка PDF пользователю
6. Подтверждение менеджеру

## Обработка ошибок

### Валидация VIN
- Неверный формат → "Неверный формат VIN. Должно быть 17 символов без I, O, Q"
- Дублирование → "Заявка с таким VIN уже существует"

### Обработка заявок
- Заявка не найдена → "Заявка не найдена"
- Неверный статус → "Неверный статус для операции"
- Неверный чат → "Команда доступна только в чате менеджеров"

### Системные ошибки
- Ошибка БД → "Временная ошибка, попробуйте позже"
- Ошибка отправки → "Ошибка отправки сообщения"

## Логирование

### Уровни
- `INFO` - создание/закрытие заявок
- `WARNING` - неверные запросы
- `ERROR` - системные ошибки

### Структура логов
```json
{
    "timestamp": "2024-01-01T12:00:00Z",
    "level": "INFO",
    "message": "Ticket created",
    "ticket_id": 123,
    "user_id": 456,
    "vin": "1HGBH41JXMN109186"
}
```

## Безопасность

### Приватность
- Не логировать полные PDF
- Не хранить персональные данные
- Логировать только ID пользователей

### Валидация
- Проверка chat_id для команд менеджера
- Валидация всех входных данных
- Ограничение доступа к командам

## Масштабируемость

### Текущая реализация
- SQLite для MVP
- Простой polling
- Один процесс

### Будущие улучшения
- PostgreSQL для продакшена
- Webhook вместо polling
- Горизонтальное масштабирование
- Redis для кеширования
